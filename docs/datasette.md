# Datasette Viewer for Pantry Pirate Radio

This document describes how Datasette is used to explore and visualize the Pantry Pirate Radio data.

## Overview

[Datasette](https://datasette.io/) is an open-source tool for exploring and publishing data. It helps people take data of any shape or size and publish it as an interactive, explorable website and accompanying API.

In Pantry Pirate Radio, Datasette serves as a **read-only viewer** for the SQLite database that is automatically generated by the HAARRRvest Publisher service.

## How It Works

### Data Flow

```
PostgreSQL Database → HAARRRvest Publisher → SQLite File → Datasette Viewer → Web Interface
```

1. **HAARRRvest Publisher** exports PostgreSQL data to SQLite format
2. The SQLite file is stored in the HAARRRvest repository at `sqlite/pantry_pirate_radio.sqlite`
3. **Datasette** reads this SQLite file and serves it via a web interface
4. Users can explore the data, run queries, and visualize geographic information

## Accessing Datasette

### Local Development

When running locally with Docker Compose:

```bash
# Start all services including Datasette viewer
./bouy up

# Access Datasette at:
# http://localhost:8001
```

### Production

In production deployments, Datasette is typically accessed at port 8001 of your server.

## Features

### Installed Plugins

The Datasette instance comes with the following plugins pre-installed:

1. **[datasette-cluster-map](https://github.com/simonw/datasette-cluster-map)** - Adds a map visualization with clustering for geographic data
2. **[datasette-leaflet](https://github.com/simonw/datasette-leaflet)** - Adds Leaflet maps for latitude/longitude columns
3. **[datasette-graphql](https://github.com/simonw/datasette-graphql)** - Adds GraphQL API support to Datasette
4. **[datasette-dashboards](https://github.com/rclement/datasette-dashboards)** - Adds dashboards with charts and visualizations
5. **[datasette-block-robots](https://github.com/simonw/datasette-block-robots)** - Blocks search engines from indexing the Datasette instance

### Available Views

The SQLite database includes several pre-created views for easier data exploration:

- `location_master` - Comprehensive view of all location data with related information
- Additional views are created by the exporter to simplify common queries

### Interactive Features

- **SQL Queries**: Write and execute custom SQL queries
- **Data Export**: Download data in JSON, CSV, or other formats
- **Map Visualizations**: Automatic map rendering for geographic data
- **API Access**: RESTful and GraphQL APIs for programmatic access
- **Faceted Search**: Filter and explore data using facets

## Docker Configuration

### Service Definition

The Datasette service is defined in `.docker/compose/base.yml`:

```yaml
datasette:
  build:
    context: ../..
    dockerfile: .docker/images/datasette/Dockerfile
  ports:
    - "8001:8001"
  volumes:
    - haarrrvest_repo:/data-repo:ro
  depends_on:
    - haarrrvest-publisher
```

The service:
- Waits for the HAARRRvest publisher to create the SQLite file
- Mounts the HAARRRvest repository as read-only
- Serves the SQLite database on port 8001

## SQLite Export Process

The SQLite export is handled by the HAARRRvest Publisher service, which:

1. Runs on startup and every 5 minutes
2. Exports the PostgreSQL database to SQLite format
3. Stores the file at `HAARRRvest/sqlite/pantry_pirate_radio.sqlite`
4. Creates metadata.json for Datasette configuration
5. Commits and pushes changes to the HAARRRvest repository

For more details on the export process, see [HAARRRvest Publisher Documentation](./haarrrvest-publisher.md).

## Troubleshooting

### Datasette Not Starting

If Datasette fails to start with "Waiting for SQLite database...":

1. Check that HAARRRvest publisher is running:
   ```bash
   ./bouy ps haarrrvest-publisher
   ```

2. Verify the SQLite file exists:
   ```bash
   ./bouy exec haarrrvest-publisher ls -la /data-repo/sqlite/
   ```

3. Trigger a manual export through HAARRRvest publisher:
   ```bash
   ./bouy haarrrvest publish
   ```

### Database Not Updated

The SQLite database is updated whenever HAARRRvest publisher runs its pipeline (every 5 minutes by default). To force an update:

```bash
# Restart the publisher to trigger immediate processing
docker-compose restart haarrrvest-publisher
```

### Map Visualizations Not Working

Ensure that your data includes valid latitude and longitude columns. The exporter automatically extracts these from PostGIS geometry fields.

## Development

### Customizing Datasette

To add new plugins or customize Datasette:

1. Edit `.docker/images/datasette/Dockerfile`
2. Add plugins to the pip install command
3. Rebuild the image:
   ```bash
   ./bouy build datasette
   ```

### Creating Custom Views

To add custom SQL views that will appear in Datasette:

1. Edit `app/datasette/exporter.py`
2. Add your view creation SQL to the `create_datasette_views()` function
3. The views will be created during the next export

## Related Documentation

- [HAARRRvest Publisher](./haarrrvest-publisher.md) - Manages SQLite export and Git synchronization
- [Architecture Overview](./architecture.md) - System architecture and data flow
- [Docker Development](./docker-development.md) - Docker setup and configuration